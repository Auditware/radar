version: 0.1.0
author: forefy
accent: anchor
name: Arbitrary Cross-Program Invocation
description: If not validated properly, when a program implements a Cross-Program Invocation, callers of the program may provide an arbitrary or untrusted program - manipulating the program to call instructions on an untrusted target program.
severity: Medium
certainty: Medium
vulnerable_example: https://github.com/Auditware/radar/blob/main/api/tests/mocks/arbitrary_cpi/bad/src/lib.rs#L11-L14
rule: |
  for source, nodes in ast:
      try:
          funcs = nodes.find_all_functions().exit_on_none()
          invoke_refs = funcs.find_by_names("invoke")
          if len(invoke_refs) == 0:
              continue
          spl_token_checks = funcs.find_by_names("spl_token", "ID")
          spl_token_2022_checks = funcs.find_by_names("spl_token_2022", "ID")
          if len(spl_token_checks) >= 2 or len(spl_token_2022_checks) >= 2:
              continue
          for invoke_ref in invoke_refs:
              print(invoke_ref.parent.to_result())
      except:
          continue