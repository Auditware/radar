version: 0.1.0
author: forefy
accent: anchor
name: Account Data Matching
description: Unpacking account structures without verifying authorization might allow an attacker to view or modify account data unintentionally. Therefore, account unpack operations should be accompanied by appropriate ownership verification.
severity: Low
certainty: Low
vulnerable_example: https://github.com/Auditware/radar/blob/main/api/tests/mocks/account_data_matching/bad/src/lib.rs#L13
rule: |
  for source, nodes in ast:
      for function in nodes.find_all_functions():
          unpack_calls = function.find_chained_calls("unpack")
          if not unpack_calls:
              continue
          
          require_macros = function.find_by_names("require")
          owner_access = function.find_member_accesses("owner")
          
          has_owner_validation = (require_macros and owner_access and len(owner_access) > 1)
          
          if not has_owner_validation:
              for unpack_call in unpack_calls:
                  print(unpack_call.to_result())
