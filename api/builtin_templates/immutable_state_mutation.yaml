version: 0.1.0
author: forefy
accent: stylus
name: Immutable State Mutation
description: Attempting to mutate constant or immutable values indicates a logic error or potential security issue.
severity: Low
certainty: Low
vulnerable_example: https://github.com/Auditware/radar/blob/main/api/tests/mocks/immutable_state_mutation/bad/lib.rs#L14
rule: |
  for source, nodes in ast:
    try:
      funcs = nodes.find_all_functions().exit_on_none()
      for func in funcs:
        access_path = func.access_path or ""
        if ".impl." not in access_path:
          continue
        
        set_calls = func.find_by_names("set", "setter")
        if not set_calls.nodes:
          continue
        
        for set_call in set_calls:
          if not set_call.children:
            continue
          receiver = set_call.children[0]
          if not receiver:
            continue
          receiver_ident = receiver.ident or ""
          if not receiver_ident:
            continue
          if "constant" in receiver_ident or "const" in receiver_ident or "immutable" in receiver_ident or "fixed" in receiver_ident or "CONSTANT" in receiver_ident or "CONST" in receiver_ident or "IMMUTABLE" in receiver_ident or "FIXED" in receiver_ident:
            print(set_call.to_result())
            break
    except:
      continue
