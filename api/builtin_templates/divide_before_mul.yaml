version: 0.1.0
author: avigaildanesh
name: Precision Loss - Division Before Multiplication
severity: Low
certainty: Low
description: |
  Detects math expressions where division occurs before multiplication in the same
  arithmetic expression (e.g., `amount / 10000 * config.fee_rate`), leading to integer
  truncation and precision loss. Ignores safe cases like `amount * config.fee_rate / 10000`.
rule: |
  for source, nodes in ast:
      try:
          div_nodes = nodes.find_by_access_path("binary.left.binary.right.lit")
          for div_node in div_nodes:
              parent = div_node.parent
              if not parent:
                  continue

              lit_in_left = "binary.left.binary.right.lit" in div_node.access_path
              has_field_right = False
              has_field_left = False

              for c in parent.children:
                  if "binary.right.field" in c.access_path:
                      has_field_right = True
                  if "binary.left.field" in c.access_path:
                      has_field_left = True

              if has_field_left and not lit_in_left:
                  continue

              if lit_in_left and has_field_right and not has_field_left:
                  print(div_node.to_result())

      except:
          continue

