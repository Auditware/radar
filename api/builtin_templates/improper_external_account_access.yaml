name: Improper External Account Access
description: Detects incorrect patterns for accessing external accounts or making external calls. Using wrong access patterns can cause transaction failures or security vulnerabilities.
severity: Medium
certainty: Low
vulnerable_example: https://github.com/Auditware/radar/blob/main/api/tests/mocks/improper_external_account_access/bad/lib.rs#L12-L14
rule: |
  for source, nodes in ast:
    try:
      funcs = nodes.find_all_functions().exit_on_none()
      for func in funcs:
        access_path = func.access_path or ""
        if ".impl." not in access_path:
          continue
        
        has_call = func.find_by_names("call", "Call")
        if not has_call.nodes:
          continue
        
        has_safe_call = func.find_by_names("Call::new", "Call::new_in")
        if has_safe_call.nodes:
          continue
        
        has_error_handling = func.find_by_names("Result", "?", "map_err")
        if has_error_handling.nodes:
          continue
        
        func_ident = func.find_by_names(func.ident).exit_on_none().first()
        if func_ident.parent and func_ident.parent.metadata:
          print(func_ident.parent.to_result())
        else:
          print(func_ident.to_result())
    except:
      continue
