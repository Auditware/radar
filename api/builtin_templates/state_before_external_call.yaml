version: 0.1.0
author: forefy
accent: stylus
name: State Updated Before External Call
description: Updating state after external calls can lead to reentrancy vulnerabilities where the called contract can re-enter and exploit inconsistent state.
severity: Low
certainty: Low
vulnerable_example: https://github.com/Auditware/radar/blob/main/api/tests/mocks/state_before_external_call/bad/lib.rs#L17-L19
rule: |
  for source, nodes in ast:
    try:
      funcs = nodes.find_all_functions().exit_on_none()
      for func in funcs:
        access_path = func.access_path or ""
        if ".impl." not in access_path:
          continue
        
        has_set_call = func.find_by_names("set")
        if not has_set_call.nodes:
          continue
        
        has_external_call = func.find_by_names("call")
        if not has_external_call.nodes:
          continue
        
        body_nodes = func.find_by_names("set", "executed")
        if body_nodes.nodes:
          func_ident = func.find_by_names(func.ident).exit_on_none()
          print(func_ident.first().to_result())
    except:
      continue
