#!/bin/bash
set -e

export COMPOSE_BAKE=true

INITIAL_DIR=$(pwd)
RADAR_BASE_DIR="${XDG_CONFIG_HOME:-$HOME}/.radar"

usage() {
    echo "Usage: $0 <command> [options]"
    echo ""
    echo "Commands:"
    echo "  scan                  Scan a contract for vulnerabilities (default command)"
    echo "  update                Update radar to the latest version"
    echo "  info                  Display information about available templates"
    echo "  list-templates        List all available templates grouped by language/framework"
    echo ""
    echo "Scan Options:"
    echo "  -p, --path            Path to the target contract on the local filesystem                                      (required)"
    echo "  -s, --source          Specific source/scope within the contract path                                           (optional) (default - project root)"
    echo "  -t, --templates       Path to the templates directory                                                          (optional) (default - builtin_templates folder)"
    echo "  -i, --ignore          Comma-separated severities to ignore (low,medium,high,uncertain)                                   (optional)"
    echo "  -o, --output          Results output file path (output type controlled by extension e.g. .json/.md/.sarif)     (optional) (default - current directory)"
    echo "  -a, --ast             Additionally output the scanned contract's parsed AST                                    (optional)"
    echo "  -d, --dev             Use development docker-compose file for local builds and enable debug output             (optional)"
    echo "  -ss, --store-sarif    Store and accumulate SARIF results from previous runs                                    (optional) (default - clean slate)"
    echo "  -u, --update          Check for and pull latest Docker images before running                                   (optional)"
    echo "  -h, --help            Show this help message                                                                   (optional)"
    exit 1
}

check_docker() {
    local timeout_duration=5
    local retries=10

    for ((i=1; i<=retries; i++)); do
      if docker info > /dev/null 2>&1; then
        return
      else
        echo "[w] Docker is not available. Retrying in $timeout_duration seconds..."
        sleep "$timeout_duration"
      fi
    done

    echo "[e] Docker was not available after $retries attempts. Please ensure Docker is installed and running. If further problems arise, consider restarting the Docker service."
    exit 1
}


adjust_source_path_for_docker() {
    local base="$1"
    local target="$2"

    local resolved_base=$(cd "$base" && pwd)
    local resolved_target=$(cd "$(dirname "$base/$target")" && pwd)/$(basename "$target")

    if [[ "$resolved_target" == "$resolved_base"* ]]; then
        local rel_path="${resolved_target#$resolved_base/}"
        echo "$rel_path"
    else
        echo "$target"
    fi
}

handle_update_command() {
    echo "[i] Updating radar..."
    
    # Run the install script to update the radar repository
    curl -sL https://raw.githubusercontent.com/auditware/radar/main/install-radar.sh | bash
    
    if [ $? -ne 0 ]; then
        echo "[w] Install script encountered an issue, but continuing with Docker image updates..."
    fi
    
    # Update Docker images
    check_docker
    cd "$RADAR_BASE_DIR"
    
    compose_file="docker-compose.yml"
    
    arm_specific_flag=""
    if [[ "$(uname -m)" == "arm64" ]] || [[ "$(uname -m)" == "aarch64" ]]; then
        arm_specific_flag="--platform linux/amd64"
    fi
    
    echo "[i] Updating Docker images..."
    docker pull $arm_specific_flag ghcr.io/auditware/radar-controller:main > /dev/null 2>&1
    docker pull $arm_specific_flag ghcr.io/auditware/radar-api:main > /dev/null 2>&1
    
    echo "[i] Restarting containers with updated images..."
    docker compose -f "$compose_file" down > /dev/null 2>&1
    docker compose -f "$compose_file" up -d --quiet-pull > /dev/null 2>&1
    
    cd "$INITIAL_DIR"
    echo "[i] Radar updated successfully!"
    exit 0
}

handle_info_command() {
    echo "[i] Fetching template information"
    
    check_docker
    cd "$RADAR_BASE_DIR"
    
    compose_file="docker-compose.yml"
    if [ "$development_mode" = true ] && [ -d "controller" ] && [ -f "docker-compose-dev.yml" ]; then
        compose_file="docker-compose-dev.yml"
        echo "[i] Running in development mode"
        
        # Sync local code if in dev mode
        rsync_opts="-aq --delete"
        if [ -f "$INITIAL_DIR/.rsyncignore" ]; then
            rsync_opts="$rsync_opts --exclude-from=$INITIAL_DIR/.rsyncignore"
        fi
        
        if [ -d "$INITIAL_DIR/api" ]; then
            rsync $rsync_opts "$INITIAL_DIR/api/" "$RADAR_BASE_DIR/api/"
        fi
    fi
    
    # Ensure containers are running
    docker compose -f "$compose_file" up -d --quiet-pull > /dev/null 2>&1
    
    # Wait for containers to be ready
    sleep 2
    
    # Execute the radar_info.py script
    docker compose -f "$compose_file" exec -T api python3 /api/scripts/radar_info.py
    
    cd "$INITIAL_DIR"
    exit 0
}

handle_list_templates_command() {
    check_docker
    cd "$RADAR_BASE_DIR"
    
    compose_file="docker-compose.yml"
    templates_dir="$RADAR_BASE_DIR/api/builtin_templates"
    
    if [ "$development_mode" = true ] && [ -d "$INITIAL_DIR/api/builtin_templates" ]; then
        templates_dir="$INITIAL_DIR/api/builtin_templates"
        echo "[d] Using local templates directory"
    fi
    
    if [ ! -d "$templates_dir" ]; then
        echo "[e] Templates directory not found: $templates_dir"
        exit 1
    fi
    
    echo ""
    echo "Available Templates"
    echo "==================="
    echo ""
    
    # Rust - Anchor templates
    anchor_templates=$(for template in "$templates_dir"/*.yaml; do
        if grep -q "^accent: anchor" "$template" 2>/dev/null; then
            grep "^name:" "$template" | sed 's/name: *//'
        fi
    done | sort)
    
    anchor_count=$(echo "$anchor_templates" | grep -c "^" 2>/dev/null || echo 0)
    if [ "$anchor_count" -gt 0 ]; then
        echo "Rust - Anchor (Solana) [$anchor_count templates]"
        echo "-----------------------------------"
        echo "$anchor_templates" | sed 's/^/  • /'
        echo ""
    fi
    
    # Rust - Stylus templates
    stylus_templates=$(for template in "$templates_dir"/*.yaml; do
        if grep -q "^accent: stylus" "$template" 2>/dev/null; then
            grep "^name:" "$template" | sed 's/name: *//'
        fi
    done | sort)
    
    stylus_count=$(echo "$stylus_templates" | grep -c "^" 2>/dev/null || echo 0)
    if [ "$stylus_count" -gt 0 ]; then
        echo "Rust - Stylus (Arbitrum) [$stylus_count templates]"
        echo "-----------------------------------"
        echo "$stylus_templates" | sed 's/^/  • /'
        echo ""
    fi
    
    # Solidity templates
    solidity_templates=$(for template in "$templates_dir"/*.yaml; do
        if grep -q "^language: solidity" "$template" 2>/dev/null; then
            grep "^name:" "$template" | sed 's/name: *//'
        fi
    done | sort)
    
    solidity_count=$(echo "$solidity_templates" | grep -c "^" 2>/dev/null || echo 0)
    if [ "$solidity_count" -gt 0 ]; then
        echo "Solidity [$solidity_count templates]"
        echo "-----------------------------------"
        echo "$solidity_templates" | sed 's/^/  • /'
        echo ""
    fi
    
    total=$((anchor_count + stylus_count + solidity_count))
    echo "Total: $total templates"
    echo ""
    
    cd "$INITIAL_DIR"
    exit 0
}

path=""
source_directory_or_file=""
ignore_severities=""
output_directory="$INITIAL_DIR"
generate_ast=false
shutdown_containers=false
development_mode=false
store_sarif=false
check_update=false

# Check if first argument is a command
command=""
if [[ "$1" == "update" ]]; then
    command="update"
    shift
elif [[ "$1" == "info" ]]; then
    command="info"
    shift
elif [[ "$1" == "list-templates" ]]; then
    command="list-templates"
    shift
elif [[ "$1" == "scan" ]]; then
    command="scan"
    shift
elif [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    usage
elif [[ "$1" != "-"* ]] && [[ -n "$1" ]]; then
    # If first arg is not a flag and not empty, it might be an unknown command
    echo "[e] Unknown command: $1"
    echo "[i] Available commands: scan, update, info, list-templates"
    usage
fi

# Default command is scan if not specified
if [[ -z "$command" ]]; then
    command="scan"
fi

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -p|--path) path=$(realpath "$2" 2>/dev/null || echo "$2"); shift ;;
        -s|--source) source_directory_or_file=$(adjust_source_path_for_docker "$path" "$2"); shift ;;
        -t|--templates) templates_directory=$(realpath "$2" 2>/dev/null || echo "$2"); shift ;;
        -a|--ast) generate_ast=true ;;
        -i|--ignore) ignore_severities="$2"; shift ;;
        -o|--output) output_directory=$(realpath "$2" 2>/dev/null || echo "$2"); shift ;;
        -k|--kill-after) shutdown_containers=true ;;
        -d|--dev) development_mode=true ;;
        -u|--update) check_update=true ;;
        -ss|--store-sarif) store_sarif=true ;;
        -h|--help) usage ;;
        *) echo "[e] Unknown argument: $1"; usage ;;
    esac
    shift
done

# Execute command
if [[ "$command" == "update" ]]; then
    handle_update_command
elif [[ "$command" == "info" ]]; then
    handle_info_command
elif [[ "$command" == "list-templates" ]]; then
    handle_list_templates_command
fi

# If command is scan, continue with normal flow

export RADAR_DEV_MODE=$development_mode

# Check if radar directory exists and reinstall if missing
if [ ! -d "$RADAR_BASE_DIR" ]; then
    echo "[w] radar directory not found at $RADAR_BASE_DIR"
    echo "[i] Running installation to set up radar directory..."
    
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    
    if [ -f "$SCRIPT_DIR/install-radar.sh" ]; then
        bash "$SCRIPT_DIR/install-radar.sh"
    else
        echo "[e] Install script not found. Please run the install script manually."
        exit 1
    fi
fi

# Determine which docker-compose file to use
cd "$RADAR_BASE_DIR"
compose_file="docker-compose.yml"
if [ "$development_mode" = true ] && [ -d "controller" ] && [ -f "docker-compose-dev.yml" ]; then
    echo "[i] Running in development mode"
    compose_file="docker-compose-dev.yml"
fi
cd "$INITIAL_DIR"

if [ "$shutdown_containers" = true ] && [ -z "$path" ]; then
    echo "[i] Shutting down radar containers"
    cd "$RADAR_BASE_DIR"
    docker compose -f "$compose_file" down --quiet
    exit 0
fi

check_docker

arm_specific_flag=""
if [[ "$(uname -m)" == "arm64" ]] || [[ "$(uname -m)" == "aarch64" ]]; then
    arm_specific_flag="--platform linux/amd64"
fi

check_image_update() {
    local image="$1"
    local registry="$2"
    local registry_digest

    registry_digest=$(docker pull $arm_specific_flag "$registry" > /dev/null 2>&1 && docker inspect --format="{{index .RepoDigests 0}}" "$registry" 2>/dev/null)

    if [ -z "$registry_digest" ]; then
        echo "[w] Could not retrieve the digest for $registry. Skipping update check."
        return 1
    fi

    local local_digest
    local_digest=$(docker images --format "{{.Repository}}@{{.Digest}}" "$image" 2>/dev/null | head -n 1)

    if [ "$local_digest" != "$registry_digest" ]; then
        echo "[i] Updating $image to latest version"
        docker pull $arm_specific_flag "$registry" > /dev/null 2>&1
        return 0
    else
        echo "[i] $image is up to date."
        return 1
    fi
}

# Check for image updates only if --update flag is used
if [ "$check_update" = true ] && [ "$development_mode" = false ]; then
    echo "[i] Checking for Docker image updates..."
    cd "$RADAR_BASE_DIR"
    
    updated=false
    if check_image_update "ghcr.io/auditware/radar-controller" "ghcr.io/auditware/radar-controller:main"; then
        updated=true
    fi
    if check_image_update "ghcr.io/auditware/radar-api" "ghcr.io/auditware/radar-api:main"; then
        updated=true
    fi
    
    if [ "$updated" = true ]; then
        echo "[i] Restarting services with updated images..."
        docker compose -f "$compose_file" up -d --quiet-pull > /dev/null 2>&1
    fi
    
    cd "$INITIAL_DIR"
fi

if [ -z "$path" ]; then
    usage
fi

if [[ -n "$path" ]]; then
    path=$(cd "$path" && pwd)
fi
if [[ -n "$templates" ]]; then
    templates=$(cd "$templates" && pwd)
fi
cd "$RADAR_BASE_DIR"

# In dev mode, sync local code changes to ~/.radar/ BEFORE starting containers
if [ "$development_mode" = true ]; then
    echo "[i] Syncing local code changes to $RADAR_BASE_DIR"
        
    rsync_opts="-aq --delete"
    if [ -f "$INITIAL_DIR/.rsyncignore" ]; then
        rsync_opts="$rsync_opts --exclude-from=$INITIAL_DIR/.rsyncignore"
    fi
    
    if [ -d "$INITIAL_DIR/api" ]; then
        rsync $rsync_opts "$INITIAL_DIR/api/" "$RADAR_BASE_DIR/api/"
    fi
    if [ -d "$INITIAL_DIR/controller" ]; then
        rsync $rsync_opts "$INITIAL_DIR/controller/" "$RADAR_BASE_DIR/controller/"
    fi
    if [ -f "$INITIAL_DIR/docker-compose-dev.yml" ]; then
        cp "$INITIAL_DIR/docker-compose-dev.yml" "$RADAR_BASE_DIR/docker-compose-dev.yml"
    fi
fi

checksum_file="docker_checksum.sha"
current_checksum=$(cat "$compose_file" | shasum -a 256 | cut -d" " -f1)

# Clean up previous runs unless --store-sarif flag is used
if [ "$store_sarif" = false ]; then
    echo "[i] Cleaning up previous scan results"
    
    # More efficient cleanup: stop containers and remove volumes in one command
    timeout 30 docker compose -f "$compose_file" down -v --remove-orphans >/dev/null 2>&1 || {
        echo "[w] Cleanup timed out, forcing cleanup..."
        docker system prune -f --volumes >/dev/null 2>&1 || true
    }    
else
    echo "[i] Storing SARIF results - will accumulate with previous runs"
fi

# Smart build detection for dev mode
dev_build_needed=false
if [ "$development_mode" = true ]; then
    # Check if Docker-related files or source code have changed
    dev_checksum_file="docker_dev_checksum.sha"
    current_dev_checksum=$(find "$INITIAL_DIR" \( -name "Dockerfile" -o -name "pyproject.toml" -o -name "poetry.lock" -o -name "docker-compose-dev.yml" -o -path "*/api/*.py" -o -path "*/controller/*.py" \) | xargs cat 2>/dev/null | shasum -a 256 | cut -d" " -f1)
    
    if [ -f "$dev_checksum_file" ]; then
        stored_dev_checksum=$(cat "$dev_checksum_file")
        if [ "$current_dev_checksum" != "$stored_dev_checksum" ]; then
            dev_build_needed=true
            echo "[d] Docker files or source code changed, rebuilding images from source code"
        else
            echo "[d] No Docker file or source code changes detected, using existing images"
        fi
    else
        dev_build_needed=true
        echo "[d] First dev run, building images from source code"
    fi
    
    if [ "$dev_build_needed" = true ]; then
        docker compose -f "$compose_file" up -d --build --quiet-pull
        echo "$current_dev_checksum" > "$dev_checksum_file"
    else
        docker compose -f "$compose_file" up -d --no-build --quiet-pull > /dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "[d] Failed to start containers, rebuilding..."
            docker compose -f "$compose_file" up -d --build --quiet-pull
            echo "$current_dev_checksum" > "$dev_checksum_file"
        fi
    fi
    
    # Wait for API container to be healthy
    echo "[d] Waiting for containers to be ready..."
    timeout=60
    elapsed=0
    while [ $elapsed -lt $timeout ]; do
        if docker compose -f "$compose_file" ps | grep -q "api.*healthy"; then
            break
        fi
        sleep 1
        ((elapsed++))
    done
elif [ -f "$checksum_file" ]; then
    stored_checksum=$(cat "$checksum_file")
    if [ "$current_checksum" != "$stored_checksum" ]; then
        echo "[i] Configuration changed, building images.. (if frozen - make sure Docker is available)"
        docker compose -f "$compose_file" up -d --build --quiet-pull > /dev/null 2>&1
        echo "$current_checksum" > "$checksum_file"
    else
        echo "[i] Running images.. (if frozen - make sure Docker is available)" 
        docker compose -f "$compose_file" up -d --no-build --quiet-pull > /dev/null 2>&1
    fi
else
    echo "[i] First run, building images.. (if frozen - make sure Docker is available)"
    docker compose -f "$compose_file" up -d --build --quiet-pull > /dev/null 2>&1
    echo "$current_checksum" > "$checksum_file"
fi

container_path="/contract"
if [ -n "$source_directory_or_file" ]; then
    container_path+="/${source_directory_or_file}"
fi

docker_command="docker compose -f \"$compose_file\" run --rm -T -v \"${path}\":/contract"
if [ -n "$templates_directory" ]; then
    docker_command+=" -v \"${templates_directory}\":/templates"
fi
docker_command+=" controller --path \"${path}\" --container-path \"${container_path}\""
if [ -n "$templates_directory" ]; then
    docker_command+=" --templates /templates"
    # If templates_directory is a file, pass the original filename
    if [ -f "$templates_directory" ]; then
        original_filename=$(basename "$templates_directory")
        docker_command+=" --templates-filename \"${original_filename}\""
    fi
fi
if [ "$generate_ast" = true ]; then
    docker_command+=" --ast"
fi
if [ -n "$output_directory" ]; then
    docker_command+=" --output \"${output_directory}\""
fi
if [ -n "$ignore_severities" ]; then
    docker_command+=" --ignore \"${ignore_severities}\""
fi
if [ "$development_mode" = true ]; then
    docker_command+=" --debug"
fi


# echo "[d] Executing command: $docker_command"
eval "$docker_command"

if [ "$shutdown_containers" = true ]; then
    echo "[i] Shutting down radar containers"
    cd "$RADAR_BASE_DIR"
    docker compose -f "$compose_file" down --quiet
    cd "$INITIAL_DIR"
fi

cd "$INITIAL_DIR"

# Determine output file paths based on whether output_directory is a file or directory
if [[ "$output_directory" == *".sarif" ]]; then
    output_file="$output_directory"
    docker cp radar-api:/radar_data/output.sarif "$output_file" >/dev/null 2>&1
    echo "[i] Results written to $output_file"
elif [[ "$output_directory" == *".md" ]]; then
    output_file="$output_directory"
    docker cp radar-api:/radar_data/output.md "$output_file" >/dev/null 2>&1
    echo "[i] Results written to $output_file"
elif [[ "$output_directory" == *".json" ]]; then
    output_file="$output_directory"
    docker cp radar-api:/radar_data/output.json "$output_file" >/dev/null 2>&1
    echo "[i] Results written to $output_file"
else
    mkdir -p "$output_directory"
    output_dir="${output_directory%/}"
    output_file="$output_dir/output.json"
    docker cp radar-api:/radar_data/output.json "$output_file" >/dev/null 2>&1
    echo "[i] Results written to $output_file"
fi

if [ "$generate_ast" = true ]; then
    if [[ "$output_directory" == *.* ]]; then
        ast_output="$(dirname "$output_directory")/ast.json"
    else
        output_dir="${output_directory%/}"
        ast_output="$output_dir/ast.json"
    fi
    echo "[i] Generating AST file at $ast_output"
    docker cp radar-api:/radar_data/ast.json "$ast_output" >/dev/null 2>&1
fi